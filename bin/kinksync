#!/usr/bin/env ruby
require 'bundler/setup'
require 'kinksync'
require 'getoptlong'

def display_conf_error_messagge
  puts 'Something went wrong. Your configuration seems to be invalid.'
  puts "Delete or edit manually #{Kinksync::Configuration::CONFIG_FILE} \
        and try again"
end

def display_sync_info(synced)
  if synced.empty?
    puts 'All up to date, nothing synced.'
  else
    puts 'Synced files:'
    synced.each { |f| puts f.sub(Kinksync.configuration.remote_path, '') }
  end
end

Signal.trap('INT') do
  puts "\nBye! Behave!"
  exit 130
end

options = GetoptLong.new(
  ['--help', '-h', GetoptLong::NO_ARGUMENT],
  ['--version', '-v', GetoptLong::NO_ARGUMENT]
)

def display_conf_error_messagge
  puts 'Something went wrong. Your configuration seems to be invalid.'
  puts "Delete or edit manually #{Kinksync::Configuration::CONFIG_FILE} \
        and try again"
end

def display_sync_info(synced)
  if synced.empty?
    puts 'All up to date, nothing synced.'
  else
    puts 'Synced files:'
    synced.each { |f| puts f.sub(Kinksync.configuration.remote_path, '') }
  end
end

options.quiet = true

begin
  options.each do |option|
    case option
    when '--help'
      STDOUT.puts <<-EOF
Usage: kinksync [OPTION] [PATHS_LIST]

Sync files located all over the directory tree in different computers using any cloud storage

Without arguments:
  Sync all files under remote cloud path with local storage

[PATHS_LIST] Sync recursively all files in each path

Options:
  -h, --help                      Show this help message and exit
  -v, --version                   Show version and exit
      EOF
      exit
    when '--version'
      STDOUT.puts Kinksync::VERSION
      exit
    end
  end
rescue
  puts "Invalid option. Run 'kinksync --help'"
  exit
end

if !Kinksync.configuration.remote_path
  STDOUT.puts 'You haven\'t set your cloud storage location yet. '\
              'Tell me where it is, please:'
  begin
    remote_path = File.expand_path(STDIN.gets.chomp)
    Kinksync.configure { |config| config.remote_path = remote_path }
  rescue StandardError => e
    puts e.message
    puts 'Try again or exit (CTRL-C):'
    retry
  end
else
  puts "Using #{Kinksync.configuration.remote_path} as remote path."
end

if ARGV.empty?
  puts 'Kinksyncing all files in your cloud storage location...'
  Kinksync.sync ? puts('Done!') : display_conf_error_messagge
else
  synced = []
  ARGV.each do |path|
    begin
      Kinksync.sync(path) ? synced.push(path) : display_conf_error_messagge
    rescue => e
      loop do
        puts e.message + '. Continue? (Y/n)'
        option = STDIN.gets.chomp
        if %w(n no).any? { |v| v == option.downcase }
          display_sync_info(synced)
          exit
        end
        break if %W(y yes \n).any? { |v| v == option.downcase }
        puts "OP" + option
      end
    end
  end
end
display_sync_info(synced)
